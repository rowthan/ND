$(function(){function FormatDate(strTime){var date=new Date(strTime);return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()}function load(target,number,page){var result=!1;return $(".load").html("正在加载中"),$.ajax({type:"get",url:"getpost?number="+number+" &&page="+page+"&&type="+target,cache:!1,dataType:"json",crossDomain:!0,json:"callback",timeout:2e3,async:!1,error:function(err){console.log(err),result=!1},beforeSend:function(){$(".loading").removeClass("hidden")},success:function(data){if(console.log(data),data){for(var i=0;i<data.posts.length;i++){var html="";html+=' <li class="latestpost">',html+='<div class="col-md-1 col-xs-2">',html+='<div class="username"><img src="'+data.posts[i].userId.profile.picture+'"></div>',html+='<div class="info">',html+=' <button postid="'+data.posts[i]._id+'" type="genius" class="vote rippler"><i class="fa fa-thumbs-up">'+data.posts[i].crazy_count+"</i></button>",html+='<button postid="'+data.posts[i]._id+'" type="crazy" class="vote rippler"><i class="fa fa-thumbs-down">'+data.posts[i].genius_count+"</i></button>",html+=' <div style="display:none" class="hidemenu">',html+=' <button class="rippler"><i class="fa fa-eye">'+data.posts[i].pv+"</i></button>",html+=' <button class="rippler"><i class="fa fa-comments">'+data.posts[i].comment_count+"</i></button>",html+=' <button class="rippler"><i class="fa fa-share-alt"></i></button>',html+="  </div>",html+='  <button style="margin-top:5px" postid="'+data.posts[i]._id+'" class="showinfo rippler"><i class="fa fa-angle-double-down"></i></button>',html+=" </div></div>",html+=' <div style="padding-left:5px;height:100%;" class="col-md-11 col-xs-10">',html+=' <div class="tag">',html+='  <a href="/tagsview?tag=jQuery 待解决" style="background-color:#EFF6FA;border-radius:3px;margin:0 3px;padding:2px"> jQuery 待解决</a><a href="/tagsview?tag=写法" style="background-color:#EFF6FA;border-radius:3px;margin:0 3px;padding:2px"> 写法</a>',html+=' <i style="float:right" class="fa fa-angle-down"></i>',html+=" </div>",html+='  <a href="/detail/'+data.posts[i]._id+'" class="posttitle">'+data.posts[i].posttitle+"</a>",html+=' <div class="abstract"><span postid="'+data.posts[i]._id+'" class="rippler">'+data.posts[i]["abstract"]+'...</span><a href="/detail/'+data.posts[i]._id+'" class="more"><i class="fa fa-long-arrow-right">查看全部</i></a></div>',html+='  <div class="postbody"></div>',html+="  </div>",html+='  <div class="corner"></div>',html+=" </li>",$("#"+target).find("ul li:last").after(html)}result=!0}else $(".nodata").removeClass("hidden")},complete:function(msg){$(".loading").addClass("hidden"),$(".load").html("加载更多...")}}),result}function initSlider(){carouselPage=new Slider("#slider-container",{onSlideChangeEnd:function(e){tabActive(e.index),loadcolunm(e.index)}})}function tabActive(index){for(var t,i=0;t=tab[i++];)t.classList.remove("active");tab[index].classList.add("active")}function initTabbar(){for(var t,i=0;t=tab[i++];)!function(i){t.addEventListener("click",function(){carouselPage.slideTo(i-1),tabActive(i-1)},!1)}(i)}function loadcolunm(index){var slider=$(".slider-slide")[index],id=slider.getAttribute("id"),content=$("#"+id).find("li");content.length<2&&load(id,column[index].number,column[index].page)&&column[index].page++}$(".ajax li a").on("click",function(){var ifget=$(this).attr("get");if("no"==ifget){$(this).attr("get","yes");var target=$(this).attr("href"),type=$(this).attr("con-type"),number=4;$.ajax({type:"get",url:"/home/ajax_getpost?type="+type+"&&number="+number}).done(function(ret){if(0==ret.code){var html="";$.each(ret.data,function(idx,item){html='<div class="post"><img style="width:40px;height:40px;margin-right:20px" src="'+item.postpic+'"><a href="/detail/'+item._id+'">'+item.posttitle+'</a><br><span><i class="fa fa-comment-o"></i>'+item.comment_count+'<i style="margin-left:5px" class="fa fa-calendar"></i>'+FormatDate(item.createAt)+"</span>                                </div>",$(target).append(html)})}else alert("请求失败！发生错误")})}}),$(".load").click(function(){load()}),$(document).on("click",".showinfo",function(){$(".barrage").remove(),$(this).prev().slideToggle("slow");var target=$(this).parents(".latestpost");target.toggleClass("active");var abstract=$(this).parent().parent().next().children(".abstract");abstract.slideToggle("slow");var postbody=abstract.next(),postid=$(this).attr("postid");postbody.html()||$.ajax({type:"get",url:"ajax_getpostbody?postid="+postid+"&&comment=yes",cache:!1,async:!1,dataType:"json",crossDomain:!0,json:"callback",timeout:6e3,error:function(err){alert("获取失败 请重试")},beforeSend:function(){},success:function(data){function barrager(){return run_once&&(looper=setInterval(barrager,looper_time),run_once=!1),postbody.barrager({img:data.comments[index].from.profile.picture,info:data.comments[index].content.replace(/<\/?.+?>/gi,"")}),index++,index==total?(clearInterval(looper),!1):void 0}if(data&&(postbody.html(data.postbody),data.comments)){var looper_time=2e3,total=data.length,run_once=!0,index=0;barrager()}},complete:function(msg){}}),postbody.slideToggle("slow")}),$(document).on("click",".abstract span",function(){$(".barrage").remove();var abstract=$(this).parents(".abstract"),showinfo=abstract.parent().prev().find(".showinfo");showinfo.prev().slideToggle("slow");var postbody=abstract.next(),postid=$(this).attr("postid");postbody.html()||$.ajax({type:"get",url:"ajax_getpostbody?postid="+postid+"&&comment=yes",cache:!1,async:!1,dataType:"json",crossDomain:!0,json:"callback",timeout:6e3,error:function(err){alert("获取失败 请重试")},beforeSend:function(){},success:function(data){function barrager(){return run_once&&(looper=setInterval(barrager,looper_time),run_once=!1),postbody.barrager({img:data.comments[index].from.profile.picture,info:data.comments[index].content.replace(/<\/?.+?>/gi,"")}),index++,index==total?(clearInterval(looper),!1):void 0}if(data&&(postbody.html(data.postbody),data.comments)){var looper_time=2e3,total=data.length,run_once=!0,index=0;barrager()}},complete:function(msg){}}),abstract.slideToggle("slow"),postbody.slideToggle("slow")}),$(document).on("click",".vote",function(){var target=$(this),another_target=target.siblings("button"),count=target.find("i").first().html(),another_count=another_target.find("i").first().html(),type=$(this).attr("type"),userid=$("#userid").html(),postid=$(this).attr("postid");if(userid){var result=vote(postid,type);result.inc&&target.find("i").first().html(Number(count)+1),result.dec&&another_target.find("i").first().html(Number(another_count)-1)}else $(".theme-popover-mask").fadeIn(100),$(".theme-popover").slideDown(200)});for(var slider=$(".slider-slide"),column=[{typeId:"latest",page:2,number:6}],col={typeId:"id",page:1,number:6},i=1;i<slider.length;i++)col.typeId=slider[i].getAttribute("id"),column.push({typeId:col.typeId,page:col.page,number:col.number});var red=blue=green=255;$(window).scroll(function(){var targetR=230,targetG=230,targetB=230,scrollTop=$(document).scrollTop(),nav=$(".column"),navtoTop=$("article").offset().top,pos=(scrollTop+80)/navtoTop,alpha=scrollTop/navtoTop>1?1:scrollTop/navtoTop;pos>=1?(pos=1,nav.css({position:"fixed",top:"40px",width:"100%","z-index":2})):nav.css({position:"absolute",top:0}),$("nav").css({background:"RGBA(80,171,226,"+alpha+")"}),$("nav .setimg").css({opacity:alpha}),$("nav .doutu, .video").css({transform:"scale("+alpha+")"}),red=Math.ceil(targetR/pos),green=Math.ceil(targetG/pos),blue=Math.ceil(targetB/pos);var windowHeight=$(window).height(),documentHeight=$(document).height();if(scrollTop>=documentHeight-windowHeight){var index=$(".slider-wrapper .active").index(),targetId=column[index].typeId,number=column[index].number,page=column[index].page;load(targetId,number,page)&&column[index].page++}});$(".rippler").ripple({color:"rgba(239,228,176,0.7)"}),$(".twentytwenty-container[data-orientation!='vertical']").twentytwenty({default_offset_pct:.5});var carouselPage,tabbar=document.getElementById("tabbar"),tab=tabbar.querySelectorAll(".tab");window.addEventListener("load",function(){initSlider(),initTabbar()},!1),$(window).scroll(function(){var winTop=$(window).scrollTop();winTop>=30?$("nav .user").addClass("goleft"):$("nav .user").removeClass("goleft")})});